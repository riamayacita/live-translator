<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Voice Translator</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 1em;
      background: #f4f4f4;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: white;
      padding: 1em;
      border-radius: 8px;
    }
    textarea {
      width: 100%;
      height: 100px;
    }
    select, button {
      margin-top: 0.5em;
      padding: 0.5em;
      width: 100%;
    }
    .translation-section {
      background: #eef;
      padding: 1em;
      margin-top: 1em;
      border-radius: 6px;
    }
    .audio-controls {
      display: flex;
      gap: 0.5em;
      margin-top: 0.5em;
    }
    @media screen and (max-width: 480px) {
      .audio-controls {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h2>Voice Translator</h2>
  <button onclick="startRecognition()">üé§ Start Recording</button>
  <button onclick="stopRecognition()">üõë Stop Recording</button>
  <br><br>
  <label>Source Language:</label>
  <select id="sourceLang">
    <option value="auto">Detect Language</option>
    <option value="en">English</option>
    <option value="es">Spanish</option>
    <option value="id">Indonesian</option>
    <option value="it">Italian</option>
    <!-- Add more if needed -->
  </select>

  <label>Target Language:</label>
  <select id="targetLang">
    <option value="es">Spanish</option>
    <option value="en">English</option>
    <option value="id">Indonesian</option>
    <option value="it">Italian</option>
    <!-- Add more if needed -->
  </select>

  <br><br>
  <label>Original:</label>
  <textarea id="inputText" placeholder="Speak or type..."></textarea>
  <button onclick="translateText()">Translate</button>

  <div class="translation-section" id="translationOutput" style="display: none;">
    <h4>Translation:</h4>
    <p id="translatedText"></p>
    <div class="audio-controls">
      <button onclick="speakTranslation()">‚ñ∂Ô∏è Play</button>
      <button onclick="pauseSpeech()">‚è∏Ô∏è Pause</button>
      <button onclick="resumeSpeech()">‚ñ∂Ô∏è Resume</button>
    </div>
    <button onclick="downloadTranslation()">üíæ Download Text</button>
  </div>
</div>

<script>
  let recognition;
  let synth = window.speechSynthesis;
  let utterance;

  function startRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      alert("Speech Recognition not supported");
      return;
    }

    recognition = new SpeechRecognition();
    recognition.lang = document.getElementById("sourceLang").value === "auto" ? "en-US" : document.getElementById("sourceLang").value;
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;

    recognition.onresult = function(event) {
      const transcript = event.results[0][0].transcript;
      document.getElementById("inputText").value = transcript;
      translateText();
    };

    recognition.start();
  }

  function stopRecognition() {
    if (recognition) {
      recognition.stop();
    }
  }

  async function translateText() {
    const text = document.getElementById("inputText").value.trim();
    const source = document.getElementById("sourceLang").value;
    const target = document.getElementById("targetLang").value;
    if (!text) return;

    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${source}&tl=${target}&dt=t&q=${encodeURIComponent(text)}`);
    const data = await res.json();
    const translated = data[0].map(d => d[0]).join(" ");
    document.getElementById("translatedText").innerText = translated;
    document.getElementById("translationOutput").style.display = "block";
  }

  function speakTranslation() {
    const text = document.getElementById("translatedText").innerText;
    const lang = document.getElementById("targetLang").value;
    if (synth.speaking) synth.cancel();
    utterance = new SpeechSynthesisUtterance(text);

    const voices = synth.getVoices();
    utterance.lang = lang;

    // Pick the best matching non-default and natural voice
    const matchingVoices = voices.filter(v => v.lang.startsWith(lang));
    if (matchingVoices.length > 0) {
      const naturalVoice = matchingVoices.find(v => !v.name.toLowerCase().includes("google") && !v.name.toLowerCase().includes("default")) || matchingVoices[0];
      utterance.voice = naturalVoice;
    }

    synth.speak(utterance);
  }

  function pauseSpeech() {
    if (synth.speaking && !synth.paused) synth.pause();
  }

  function resumeSpeech() {
    if (synth.paused) synth.resume();
  }

  function downloadTranslation() {
    const original = document.getElementById("inputText").value.trim();
    const translated = document.getElementById("translatedText").innerText.trim();
    const textToSave = `Original:\n${original}\n\nTranslation:\n${translated}`;
    const blob = new Blob([textToSave], { type: "text/plain" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "translation.txt";
    a.click();
  }

  // Ensure voices are loaded
  window.speechSynthesis.onvoiceschanged = () => {};
</script>
</body>
</html>
